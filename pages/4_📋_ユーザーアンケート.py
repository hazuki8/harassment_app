# pages/4_ğŸ—£ï¸_ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ã‚¹ãƒˆ.py ã¨ã—ã¦æ–°è¦ä½œæˆ

import streamlit as st
from utils.db import save_feedback, check_feedback_status

st.set_page_config(page_title="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ", page_icon="ğŸ“‹")

st.title("ğŸ“‹ åˆ©ç”¨å¾Œã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ")
st.markdown("""æœ¬ã‚·ã‚¹ãƒ†ãƒ ã®æœ‰åŠ¹æ€§ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã®**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ**ã§ã™ã€‚è¨ºæ–­çµæœã‚’è¦‹ãŸç‡ç›´ãªæ„Ÿæƒ³ã‚’ãŠèã‹ã›ãã ã•ã„ã€‚""")
st.divider()

# ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
if "user_id" not in st.session_state or not st.session_state.user_id:
    st.warning("âš ï¸ å…ˆã«è¨ºæ–­ï¼ˆã€Œãƒ‘ãƒ¯ãƒãƒ©èªè­˜å‚¾å‘ãƒã‚§ãƒƒã‚¯ã€ï¼‰ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚")
    st.stop()

# å›ç­”æ¸ˆã¿ãƒã‚§ãƒƒã‚¯
if check_feedback_status(st.session_state.user_id):
    st.success("âœ… ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã¸ã®ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼")
    st.info("ã‚ãªãŸã®å›ç­”ã¯è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦çµ‚äº†ã—ã¦ãã ã•ã„ã€‚")
    st.stop()

# ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒ 
with st.form("feedback_form"):
    st.subheader("1. æ°—æŒã¡ã®å¤‰åŒ–ã«ã¤ã„ã¦")
    st.caption("ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆ©ç”¨ã™ã‚‹ã€Œå‰ã€ã¨ã€Œå¾Œã€ã®æ°—æŒã¡ã‚’æ¯”è¼ƒã—ã¦æ•™ãˆã¦ãã ã•ã„ã€‚")
    
    c1, c2 = st.columns(2)
    with c1:
        st.markdown("**Q1. åˆ©ç”¨ã™ã‚‹ã€å‰ã€‘**")
        st.markdown("éƒ¨ä¸‹ã¸ã®æŒ‡å°ã‚„æ³¨æ„ã‚’ã™ã‚‹éš›ã€ã€Œãƒ‘ãƒ¯ãƒãƒ©ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€ã¨ä¸å®‰ã‚„è¿·ã„ã‚’æ„Ÿã˜ã¦ã„ã¾ã—ãŸã‹ï¼Ÿ")
        q_anxiety_pre = st.slider("åˆ©ç”¨å‰", 1, 5, 3, key="pre", format="%d")
        st.caption("1:å…¨ãæ„Ÿã˜ã¦ã„ãªã„ ã€œ 5:å¼·ãæ„Ÿã˜ã¦ã„ãŸ")
        
    with c2:
        st.markdown("**Q2. åˆ©ç”¨ã—ãŸã€å¾Œã€‘ï¼ˆç¾åœ¨ï¼‰**")
        st.markdown("è‡ªåˆ†ã®åˆ¤æ–­åŸºæº–ã‚„å‚¾å‘ãŒå¯è¦–åŒ–ã•ã‚ŒãŸã“ã¨ã§ã€ãã®ä¸å®‰ã‚„è¿·ã„ã¯ã©ã†å¤‰åŒ–ã—ãã†ã§ã™ã‹ï¼Ÿ")
        q_anxiety_post = st.slider("åˆ©ç”¨å¾Œ", 1, 5, 3, key="post", format="%d")
        st.caption("1:è§£æ¶ˆã•ã‚Œãã†/è¿·ã‚ãªã„ ã€œ 5:å¤‰ã‚ã‚‰ãªã„/ä½™è¨ˆã«è¿·ã†")

    st.markdown("---")
    st.subheader("2. ã‚·ã‚¹ãƒ†ãƒ ã®è©•ä¾¡")
    
    st.markdown("**Q3. è‡ªå·±ç†è§£ï¼ˆå†…çœï¼‰**")
    st.markdown("è‡ªåˆ†ãŒã€Œã©ã®ã‚ˆã†ãªå ´é¢ã§å³ã—ãï¼ˆã¾ãŸã¯ç”˜ãï¼‰åˆ¤æ–­ã—ã‚„ã™ã„ã‹ã€ã¨ã„ã†å‚¾å‘ã‚’ç†è§£ã§ãã¾ã—ãŸã‹ï¼Ÿ")
    q_self_awareness = st.select_slider(
        "é¸æŠã—ã¦ãã ã•ã„",
        options=["1.å…¨ãç†è§£ã§ããªã‹ã£ãŸ", "2.ã‚ã¾ã‚Šç†è§£ã§ããªã‹ã£ãŸ", "3.ã©ã¡ã‚‰ã¨ã‚‚è¨€ãˆãªã„", "4.ã‚ã‚‹ç¨‹åº¦ç†è§£ã§ããŸ", "5.ã‚ˆãç†è§£ã§ããŸ"],
        value="3.ã©ã¡ã‚‰ã¨ã‚‚è¨€ãˆãªã„"
    )

    st.markdown("**Q4. ç´å¾—æ„Ÿãƒ»æ•´ç†æ„Ÿ**")
    st.markdown("ã€Œç™½é»’ã¯ã£ãã‚Šã—ãªã„ã‚°ãƒ¬ãƒ¼ãªäº‹ä¾‹ã€ã‚„ã€Œä¸–ã®ä¸­ã¨ã®ã‚ºãƒ¬ã€ã‚’è¦‹ã¦ã€åˆ¤æ–­ã®æ•´ç†ãŒã¤ãã¾ã—ãŸã‹ï¼Ÿ")
    q_clarity = st.select_slider(
        "é¸æŠã—ã¦ãã ã•ã„",
        options=["1.å…¨ãæ•´ç†ã§ããªã‹ã£ãŸ", "2.ã‚ã¾ã‚Šæ•´ç†ã§ããªã‹ã£ãŸ", "3.ã©ã¡ã‚‰ã¨ã‚‚è¨€ãˆãªã„", "4.ã‚ã‚‹ç¨‹åº¦æ•´ç†ãŒã¤ã„ãŸ", "5.éå¸¸ã«ã‚¹ãƒƒã‚­ãƒªã—ãŸ"],
        value="3.ã©ã¡ã‚‰ã¨ã‚‚è¨€ãˆãªã„",
        key="clarity"
    )
    
    st.markdown("**Q5. æ··ä¹±ï¼ˆé€†è³ªå•ï¼‰**")
    st.markdown("é€†ã«ã€æƒ…å ±ãŒå¤šã™ãã¦ã€Œä½™è¨ˆã«ã©ã†åˆ¤æ–­ã—ã¦ã„ã„ã‹åˆ†ã‹ã‚‰ãªããªã£ãŸã€ã¨ã„ã†ã“ã¨ã¯ã‚ã‚Šã¾ã—ãŸã‹ï¼Ÿ")
    q_confusion = st.radio(
        "",
        options=["ã„ã„ãˆã€æ··ä¹±ã¯ã—ã¦ã„ãªã„", "ã¯ã„ã€ä½™è¨ˆã«æ··ä¹±ã—ãŸ"],
        horizontal=True
    )
    # DBä¿å­˜ç”¨ã«æ•°å€¤åŒ–ï¼ˆ1:æ··ä¹±ãªã—, 5:æ··ä¹±ã‚ã‚Šï¼‰
    val_confusion = 5 if q_confusion == "ã¯ã„ã€ä½™è¨ˆã«æ··ä¹±ã—ãŸ" else 1

    st.markdown("---")
    st.markdown("**Q6. è‡ªç”±è¨˜è¿°ï¼ˆä»»æ„ï¼‰**")
    free_comment = st.text_area("æ°—ã¥ã„ãŸç‚¹ã€æ„Ÿæƒ³ã€æ”¹å–„è¦æœ›ãªã©ã‚’ã”è‡ªç”±ã«ãŠæ›¸ããã ã•ã„ã€‚")
    
    submitted = st.form_submit_button("å›ç­”ã‚’é€ä¿¡ã™ã‚‹", type="primary", use_container_width=True)

    if submitted:
        # ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®æ–‡å­—åˆ—ã‹ã‚‰æ•°å€¤ã‚’å–ã‚Šå‡ºã™å‡¦ç†ï¼ˆ"5.ã‚ˆãç†è§£ã§ããŸ" -> 5ï¼‰
        val_self = int(q_self_awareness[0])
        val_clarity = int(q_clarity[0])
        
        if save_feedback(
            st.session_state.user_id,
            q_anxiety_pre,
            q_anxiety_post,
            val_self,
            val_clarity,
            val_confusion,
            free_comment
        ):
            st.balloons()
            st.success("é€ä¿¡å®Œäº†ã—ã¾ã—ãŸã€‚ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼")
            st.rerun() # ç”»é¢æ›´æ–°ã—ã¦ã€Œå›ç­”æ¸ˆã¿ã€è¡¨ç¤ºã¸